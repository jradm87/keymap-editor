{"ast":null,"code":"import _asyncToGenerator from\"/home/runner/work/keymap-editor/keymap-editor/app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _classCallCheck from\"/home/runner/work/keymap-editor/keymap-editor/app/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/home/runner/work/keymap-editor/keymap-editor/app/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _inherits from\"/home/runner/work/keymap-editor/keymap-editor/app/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/home/runner/work/keymap-editor/keymap-editor/app/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import _regeneratorRuntime from\"/home/runner/work/keymap-editor/keymap-editor/app/node_modules/@babel/runtime/regenerator/index.js\";import axios from'axios';import EventEmitter from'eventemitter3';import*as config from'../../config';export var API=/*#__PURE__*/function(_EventEmitter){_inherits(API,_EventEmitter);var _super=_createSuper(API);function API(){var _this;_classCallCheck(this,API);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.token=null;_this.initialized=false;_this.installations=null;_this.repositories=null;_this.repoInstallationMap=null;return _this;}_createClass(API,[{key:\"_request\",value:function(){var _request2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(options){var _err$response;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(typeof options==='string'){options={url:options};}if(options.url.startsWith('/')){options.url=\"\".concat(config.apiBaseUrl).concat(options.url);}options.headers=Object.assign({},options.headers);if(this.token&&!options.headers.Authorization){options.headers.Authorization=\"Bearer \".concat(this.token);}_context.prev=4;_context.next=7;return axios(options);case 7:return _context.abrupt(\"return\",_context.sent);case 10:_context.prev=10;_context.t0=_context[\"catch\"](4);if(((_err$response=_context.t0.response)===null||_err$response===void 0?void 0:_err$response.status)===401){console.error('Authentication failed.');this.emit('authentication-failed',_context.t0.response);}throw _context.t0;case 14:case\"end\":return _context.stop();}}},_callee,this,[[4,10]]);}));function _request(_x){return _request2.apply(this,arguments);}return _request;}()},{key:\"init\",value:function(){var _init=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var installationUrl,param,_yield$this$_request,data;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!this.initialized){_context2.next=2;break;}return _context2.abrupt(\"return\");case 2:installationUrl=\"\".concat(config.apiBaseUrl,\"/github/installation\");param=new URLSearchParams(window.location.search).get('token');if(!localStorage.auth_token&&param){window.history.replaceState({},null,window.location.pathname);localStorage.auth_token=param;}if(!localStorage.auth_token){_context2.next=16;break;}this.token=localStorage.auth_token;_context2.next=9;return this._request(installationUrl);case 9:_yield$this$_request=_context2.sent;data=_yield$this$_request.data;this.emit('authenticated');if(!data.installation){console.warn('No GitHub app installation found for authenticated user.');this.emit('app-not-installed');}this.installations=data.installations;this.repositories=data.repositories;this.repoInstallationMap=data.repoInstallationMap;case 16:case\"end\":return _context2.stop();}}},_callee2,this);}));function init(){return _init.apply(this,arguments);}return init;}()},{key:\"beginLoginFlow\",value:function beginLoginFlow(){localStorage.removeItem('auth_token');window.location.href=\"\".concat(config.apiBaseUrl,\"/github/authorize\");}},{key:\"beginInstallAppFlow\",value:function beginInstallAppFlow(){window.location.href=\"https://github.com/apps/\".concat(config.githubAppName,\"/installations/new\");}},{key:\"isGitHubAuthorized\",value:function isGitHubAuthorized(){return!!this.token;}},{key:\"isAppInstalled\",value:function isAppInstalled(){var _this$installations,_this$repositories;return((_this$installations=this.installations)===null||_this$installations===void 0?void 0:_this$installations.length)&&((_this$repositories=this.repositories)===null||_this$repositories===void 0?void 0:_this$repositories.length);}},{key:\"fetchRepoBranches\",value:function(){var _fetchRepoBranches=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(repo){var installation,repository,_yield$this$_request2,data;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:installation=encodeURIComponent(this.repoInstallationMap[repo.full_name]);repository=encodeURIComponent(repo.full_name);_context3.next=4;return this._request(\"/github/installation/\".concat(installation,\"/\").concat(repository,\"/branches\"));case 4:_yield$this$_request2=_context3.sent;data=_yield$this$_request2.data;return _context3.abrupt(\"return\",data);case 7:case\"end\":return _context3.stop();}}},_callee3,this);}));function fetchRepoBranches(_x2){return _fetchRepoBranches.apply(this,arguments);}return fetchRepoBranches;}()},{key:\"fetchLayoutAndKeymap\",value:function(){var _fetchLayoutAndKeymap=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(repo,branch){var installation,repository,url,_yield$this$_request3,data,defaultLayout,_err$response2;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:installation=encodeURIComponent(this.repoInstallationMap[repo]);repository=encodeURIComponent(repo);url=new URL(\"\".concat(config.apiBaseUrl,\"/github/keyboard-files/\").concat(installation,\"/\").concat(repository));if(branch){url.search=new URLSearchParams({branch:branch}).toString();}_context4.prev=4;_context4.next=7;return this._request(url.toString());case 7:_yield$this$_request3=_context4.sent;data=_yield$this$_request3.data;defaultLayout=data.info.layouts.default||data.info.layouts[Object.keys(data.info.layouts)[0]];return _context4.abrupt(\"return\",{layout:defaultLayout.layout,keymap:data.keymap});case 13:_context4.prev=13;_context4.t0=_context4[\"catch\"](4);if(((_err$response2=_context4.t0.response)===null||_err$response2===void 0?void 0:_err$response2.status)===400){console.error('Failed to load keymap and layout from github',_context4.t0.response.data);this.emit('repo-validation-error',_context4.t0.response.data);}throw _context4.t0;case 17:case\"end\":return _context4.stop();}}},_callee4,this,[[4,13]]);}));function fetchLayoutAndKeymap(_x3,_x4){return _fetchLayoutAndKeymap.apply(this,arguments);}return fetchLayoutAndKeymap;}()},{key:\"commitChanges\",value:function commitChanges(repo,branch,layout,keymap){var installation=encodeURIComponent(this.repoInstallationMap[repo]);var repository=encodeURIComponent(repo);return this._request({url:\"/github/keyboard-files/\".concat(installation,\"/\").concat(repository,\"/\").concat(encodeURIComponent(branch)),method:'POST',headers:{'Content-Type':'application/json'},data:{layout:layout,keymap:keymap}});}}]);return API;}(EventEmitter);export default new API();","map":{"version":3,"names":["axios","EventEmitter","config","API","token","initialized","installations","repositories","repoInstallationMap","options","url","startsWith","apiBaseUrl","headers","Object","assign","Authorization","response","status","console","error","emit","installationUrl","param","URLSearchParams","window","location","search","get","localStorage","auth_token","history","replaceState","pathname","_request","data","installation","warn","removeItem","href","githubAppName","length","repo","encodeURIComponent","full_name","repository","branch","URL","toString","defaultLayout","info","layouts","default","keys","layout","keymap","method"],"sources":["/home/runner/work/keymap-editor/keymap-editor/app/src/Pickers/Github/api.js"],"sourcesContent":["import axios from 'axios'\nimport EventEmitter from 'eventemitter3'\n\nimport * as config from '../../config'\n\nexport class API extends EventEmitter {\n  token = null\n  initialized = false\n  installations = null\n  repositories = null\n  repoInstallationMap = null\n\n  async _request (options) {\n    if (typeof options === 'string') {\n      options = {\n        url: options\n      }\n    }\n\n    if (options.url.startsWith('/')) {\n      options.url = `${config.apiBaseUrl}${options.url}`\n    }\n  \n    options.headers = Object.assign({}, options.headers)\n    if (this.token && !options.headers.Authorization) {\n      options.headers.Authorization = `Bearer ${this.token}`\n    }\n    \n    try {\n      return await axios(options)\n    } catch (err) {\n      if (err.response?.status === 401) {\n        console.error('Authentication failed.')\n        this.emit('authentication-failed', err.response)\n      }\n\n      throw err\n    }\n  }\n\n  async init() {\n    if (this.initialized) {\n      return\n    }\n\n    const installationUrl = `${config.apiBaseUrl}/github/installation`\n    const param = new URLSearchParams(window.location.search).get('token')\n    if (!localStorage.auth_token && param) {\n      window.history.replaceState({}, null, window.location.pathname)\n      localStorage.auth_token = param\n    }\n\n    if (localStorage.auth_token) {\n      this.token = localStorage.auth_token\n      const { data } = await this._request(installationUrl)\n      this.emit('authenticated')\n\n      if (!data.installation) {\n        console.warn('No GitHub app installation found for authenticated user.')\n        this.emit('app-not-installed')\n      }\n\n      this.installations = data.installations\n      this.repositories = data.repositories\n      this.repoInstallationMap = data.repoInstallationMap\n    }\n  }\n\n  beginLoginFlow() {\n    localStorage.removeItem('auth_token')\n    window.location.href = `${config.apiBaseUrl}/github/authorize`\n  }\n\n  beginInstallAppFlow() {\n    window.location.href = `https://github.com/apps/${config.githubAppName}/installations/new`\n  }\n  \n  isGitHubAuthorized() {\n    return !!this.token\n  }\n\n  isAppInstalled() {\n    return this.installations?.length && this.repositories?.length\n  }\n\n  async fetchRepoBranches(repo) {\n    const installation = encodeURIComponent(this.repoInstallationMap[repo.full_name])\n    const repository = encodeURIComponent(repo.full_name)\n    const { data } = await this._request(\n      `/github/installation/${installation}/${repository}/branches`\n    )\n\n    return data\n  }\n\n  async fetchLayoutAndKeymap(repo, branch) {\n    const installation = encodeURIComponent(this.repoInstallationMap[repo])\n    const repository = encodeURIComponent(repo)\n    const url = new URL(`${config.apiBaseUrl}/github/keyboard-files/${installation}/${repository}`)\n\n    if (branch) {\n      url.search = new URLSearchParams({ branch }).toString()\n    }\n\n    try {\n      const { data } = await this._request(url.toString())\n      const defaultLayout = data.info.layouts.default || data.info.layouts[Object.keys(data.info.layouts)[0]]\n      return {\n        layout: defaultLayout.layout,\n        keymap: data.keymap\n      }\n    } catch (err) {\n      if (err.response?.status === 400) {\n        console.error('Failed to load keymap and layout from github', err.response.data)\n        this.emit('repo-validation-error', err.response.data)\n      }\n\n      throw err\n    }\n  }\n\n  commitChanges(repo, branch, layout, keymap) {\n    const installation = encodeURIComponent(this.repoInstallationMap[repo])\n    const repository = encodeURIComponent(repo)\n\n    return this._request({\n      url: `/github/keyboard-files/${installation}/${repository}/${encodeURIComponent(branch)}`,\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      data: { layout, keymap }\n    })\n  }\n}\n\nexport default new API()\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}